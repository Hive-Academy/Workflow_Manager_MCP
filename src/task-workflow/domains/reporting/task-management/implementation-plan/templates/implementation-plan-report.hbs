{{#> base-layout title="Implementation Plan Report" reportType="Implementation Plan"}}

<!-- Implementation Plan Content -->
<div class="space-y-8">
    
    <!-- Plan Overview Card -->
    <div class="card animate-on-scroll">
        <div class="card-header">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-project-diagram text-primary-600 mr-3"></i>
                        Implementation Plan
                    </h2>
                    <p class="text-gray-600 mt-1">{{task.name}} • Plan ID: {{plan.id}}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="status-badge status-{{task.status}}">{{task.status}}</span>
                    <span class="text-sm text-gray-500">by {{plan.createdBy}}</span>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Plan Details -->
                <div class="lg:col-span-2">
                    <div class="space-y-4">
                        {{#if plan.overview}}
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Overview</h3>
                                <p class="text-gray-700">{{plan.overview}}</p>
                            </div>
                        {{/if}}
                        
                        {{#if plan.approach}}
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Approach</h3>
                                <p class="text-gray-700">{{plan.approach}}</p>
                            </div>
                        {{/if}}
                        
                        {{#if plan.architecturalRationale}}
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Architectural Rationale</h3>
                                <p class="text-gray-700">{{plan.architecturalRationale}}</p>
                            </div>
                        {{/if}}
                    </div>
                </div>
                
                <!-- Plan Metadata -->
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Plan Information</h3>
                        <dl class="space-y-2">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Created By</dt>
                                <dd class="text-sm text-gray-900">
                                    <span class="role-badge">{{plan.createdBy}}</span>
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Created Date</dt>
                                <dd class="text-sm text-gray-900">{{formatDate plan.createdAt}}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Total Batches</dt>
                                <dd class="text-sm text-gray-900">{{batches.length}}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Total Subtasks</dt>
                                <dd class="text-sm text-gray-900">{{totalSubtasks}}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Completion</dt>
                                <dd class="text-sm text-gray-900">
                                    <div class="flex items-center space-x-2">
                                        <span>{{completedSubtasks}}/{{totalSubtasks}}</span>
                                        <div class="w-16 bg-gray-200 rounded-full h-2">
                                            <div 
                                                class="bg-success-600 h-2 rounded-full transition-all duration-1000" 
                                                style="width: {{progressPercentage}}%"
                                            ></div>
                                        </div>
                                    </div>
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Technical Decisions -->
    {{#if plan.technicalDecisions}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-cogs text-indigo-600 mr-2"></i>
                    Technical Decisions
                </h3>
                <p class="text-sm text-gray-600 mt-1">Key technical choices and rationale</p>
            </div>
            <div class="card-body">
                <div class="prose prose-sm max-w-none">
                    {{#if (isString plan.technicalDecisions)}}
                        <p class="text-gray-700">{{plan.technicalDecisions}}</p>
                    {{else}}
                        <div class="space-y-3">
                            {{#each plan.technicalDecisions}}
                                <div class="border-l-4 border-indigo-500 pl-4">
                                    <h4 class="text-md font-medium text-gray-900">{{@key}}</h4>
                                    <p class="text-gray-700 mt-1">{{this}}</p>
                                </div>
                            {{/each}}
                        </div>
                    {{/if}}
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Files to Modify -->
    {{#if plan.filesToModify.length}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-file-code text-orange-600 mr-2"></i>
                    Files to Modify
                </h3>
                <p class="text-sm text-gray-600 mt-1">Files that will be created or modified during implementation</p>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {{#each plan.filesToModify}}
                        <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-file-alt text-gray-400"></i>
                            <span class="text-sm font-mono text-gray-700">{{this}}</span>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Strategic Context -->
    {{#if plan.strategicContext}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-chess text-purple-600 mr-2"></i>
                    Strategic Context
                </h3>
                <p class="text-sm text-gray-600 mt-1">Strategic considerations and business context</p>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {{#each plan.strategicContext}}
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="text-md font-medium text-gray-900 mb-2">{{@key}}</h4>
                            <p class="text-sm text-gray-600">{{this}}</p>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Implementation Batches -->
    {{#if batches.length}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-layer-group text-blue-600 mr-2"></i>
                    Implementation Batches
                </h3>
                <p class="text-sm text-gray-600 mt-1">Organized implementation phases with subtasks</p>
            </div>
            <div class="card-body">
                <div class="space-y-6">
                    {{#each batches}}
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <!-- Batch Header -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-medium text-gray-900">{{batchTitle}}</h4>
                                        <p class="text-sm text-gray-600">Batch ID: {{batchId}}</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <div class="text-right">
                                            <div class="text-sm font-medium text-gray-900">{{completedCount}}/{{totalCount}}</div>
                                            <div class="text-xs text-gray-500">completed</div>
                                        </div>
                                        <div class="w-20 bg-gray-200 rounded-full h-3">
                                            <div 
                                                class="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full transition-all duration-1000" 
                                                style="width: {{progressPercentage}}%"
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Subtasks List -->
                            <div class="divide-y divide-gray-200">
                                {{#each subtasks}}
                                    <div class="px-6 py-4 hover:bg-gray-50 transition-colors duration-150">
                                        <div class="flex items-start space-x-4">
                                            <!-- Status Icon -->
                                            <div class="flex-shrink-0 mt-1">
                                                {{#if (eq status 'completed')}}
                                                    <div class="w-6 h-6 rounded-full bg-success-100 flex items-center justify-center">
                                                        <i class="fas fa-check text-success-600 text-sm"></i>
                                                    </div>
                                                {{else if (eq status 'in-progress')}}
                                                    <div class="w-6 h-6 rounded-full bg-primary-100 flex items-center justify-center">
                                                        <i class="fas fa-clock text-primary-600 text-sm"></i>
                                                    </div>
                                                {{else}}
                                                    <div class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center">
                                                        <span class="text-gray-400 text-sm font-medium">{{sequenceNumber}}</span>
                                                    </div>
                                                {{/if}}
                                            </div>
                                            
                                            <!-- Subtask Content -->
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h5 class="text-md font-medium text-gray-900">{{name}}</h5>
                                                    <span class="status-badge status-{{status}}">{{status}}</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-3">{{description}}</p>
                                                
                                                <!-- Success Criteria -->
                                                {{#if successCriteria.length}}
                                                    <div class="mb-3">
                                                        <h6 class="text-xs font-medium text-gray-700 mb-1">Success Criteria:</h6>
                                                        <ul class="text-xs text-gray-600 space-y-1">
                                                            {{#each successCriteria}}
                                                                <li class="flex items-start space-x-1">
                                                                    <span class="text-gray-400 mt-0.5">•</span>
                                                                    <span>{{this}}</span>
                                                                </li>
                                                            {{/each}}
                                                        </ul>
                                                    </div>
                                                {{/if}}
                                                
                                                <!-- Strategic Guidance -->
                                                {{#if strategicGuidance}}
                                                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 mb-3">
                                                        <div class="flex items-start space-x-2">
                                                            <i class="fas fa-lightbulb text-indigo-600 mt-0.5"></i>
                                                            <div>
                                                                <h6 class="text-xs font-medium text-indigo-900 mb-1">Strategic Guidance</h6>
                                                                <div class="text-xs text-indigo-700 space-y-1">
                                                                    {{#each strategicGuidance}}
                                                                        <div>
                                                                            <span class="font-medium">{{@key}}:</span>
                                                                            <span>{{this}}</span>
                                                                        </div>
                                                                    {{/each}}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {{/if}}
                                                
                                                <!-- Quality Constraints -->
                                                {{#if qualityConstraints}}
                                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                                        <div class="flex items-start space-x-2">
                                                            <i class="fas fa-shield-alt text-yellow-600 mt-0.5"></i>
                                                            <div>
                                                                <h6 class="text-xs font-medium text-yellow-900 mb-1">Quality Constraints</h6>
                                                                <div class="text-xs text-yellow-700 space-y-1">
                                                                    {{#each qualityConstraints}}
                                                                        <div>
                                                                            <span class="font-medium">{{@key}}:</span>
                                                                            <span>{{this}}</span>
                                                                        </div>
                                                                    {{/each}}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {{/if}}
                                            </div>
                                        </div>
                                    </div>
                                {{/each}}
                            </div>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Quality Gates -->
    {{#if plan.qualityGates}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                    Quality Gates
                </h3>
                <p class="text-sm text-gray-600 mt-1">Quality checkpoints and validation criteria</p>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {{#each plan.qualityGates}}
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="text-md font-medium text-gray-900 mb-2 flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                {{@key}}
                            </h4>
                            <p class="text-sm text-gray-600">{{this}}</p>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Progress Summary -->
    <div class="card animate-on-scroll">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                Progress Summary
            </h3>
            <p class="text-sm text-gray-600 mt-1">Implementation progress and statistics</p>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto bg-blue-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-tasks text-blue-600 text-xl"></i>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{totalSubtasks}}</div>
                    <div class="text-sm text-gray-600">Total Subtasks</div>
                </div>
                
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto bg-green-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-check text-green-600 text-xl"></i>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{completedSubtasks}}</div>
                    <div class="text-sm text-gray-600">Completed</div>
                </div>
                
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto bg-orange-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-clock text-orange-600 text-xl"></i>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{inProgressSubtasks}}</div>
                    <div class="text-sm text-gray-600">In Progress</div>
                </div>
                
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto bg-purple-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-percentage text-purple-600 text-xl"></i>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{progressPercentage}}%</div>
                    <div class="text-sm text-gray-600">Complete</div>
                </div>
            </div>
            
            <!-- Overall Progress Bar -->
            <div class="mt-8">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Overall Progress</span>
                    <span>{{completedSubtasks}}/{{totalSubtasks}} subtasks</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div 
                        class="bg-gradient-to-r from-blue-500 to-green-500 h-4 rounded-full transition-all duration-1000" 
                        style="width: {{progressPercentage}}%"
                    ></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card animate-on-scroll">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-bolt text-yellow-600 mr-2"></i>
                Quick Actions
            </h3>
            <p class="text-sm text-gray-600 mt-1">MCP commands for plan management</p>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button onclick="copyPlanMcpCommand('get-plan')" class="btn-secondary text-left p-4 h-auto">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-info-circle text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Get Plan Details</div>
                            <div class="text-sm text-gray-500">Retrieve complete plan data</div>
                        </div>
                    </div>
                </button>
                
                <button onclick="copyPlanMcpCommand('update-batch')" class="btn-secondary text-left p-4 h-auto">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-edit text-green-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Update Batch Status</div>
                            <div class="text-sm text-gray-500">Mark batch as completed</div>
                        </div>
                    </div>
                </button>
                
                <button onclick="copyPlanMcpCommand('sync-status')" class="btn-secondary text-left p-4 h-auto">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-sync text-purple-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Sync Status</div>
                            <div class="text-sm text-gray-500">Synchronize task status</div>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>
    
</div>

<!-- Plan-specific JavaScript -->
<script>
    // Plan-specific MCP commands
    const planMcpCommands = {
        'get-plan': `planning_operations({
  operation: "get_plan",
  taskId: "{{task.taskId}}",
  includeBatches: true
})`,
        'update-batch': `batch_subtask_operations({
  operation: "update_batch_status",
  taskId: "{{task.taskId}}",
  batchId: "BATCH_ID", // Replace with specific batch ID
  newStatus: "completed"
})`,
        'sync-status': `batch_status_updates({
  operation: "sync_task_status",
  taskId: "{{task.taskId}}",
  checkConsistency: true
})`
    };
    
    window.copyPlanMcpCommand = function(commandType) {
        const command = planMcpCommands[commandType];
        if (command) {
            navigator.clipboard.writeText(command).then(() => {
                showToast(`${commandType.replace('-', ' ')} command copied!`, 'success');
            }).catch(() => {
                showToast('Failed to copy command', 'error');
            });
        }
    };
    
    // Helper for Handlebars
    if (typeof Handlebars !== 'undefined') {
        Handlebars.registerHelper('isString', function(value) {
            return typeof value === 'string';
        });
        
        Handlebars.registerHelper('multiply', function(a, b) {
            return a * b;
        });
    }
</script>

{{/base-layout}} 