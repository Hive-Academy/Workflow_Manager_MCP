{{#> base-layout title="Task Detail Report" reportType="Task Detail"}}

<!-- Task Detail Content -->
<div class="space-y-8">
    
    <!-- Task Overview Card -->
    <div class="card animate-on-scroll">
        <div class="card-header">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-tasks text-primary-600 mr-3"></i>
                        {{task.name}}
                    </h2>
                    <p class="text-gray-600 mt-1">{{task.taskId}} • Created {{formatDate task.createdAt}}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="status-badge status-{{task.status}}">{{task.status}}</span>
                    <span class="priority-badge priority-{{toLowerCase task.priority}}">{{task.priority}}</span>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Task Description -->
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Description</h3>
                    <div class="prose prose-sm max-w-none">
                        <p class="text-gray-700">{{task.description.description}}</p>
                        
                        {{#if task.description.businessRequirements}}
                            <h4 class="text-md font-medium text-gray-900 mt-4 mb-2">Business Requirements</h4>
                            <p class="text-gray-700">{{task.description.businessRequirements}}</p>
                        {{/if}}
                        
                        {{#if task.description.technicalRequirements}}
                            <h4 class="text-md font-medium text-gray-900 mt-4 mb-2">Technical Requirements</h4>
                            <p class="text-gray-700">{{task.description.technicalRequirements}}</p>
                        {{/if}}
                    </div>
                </div>
                
                <!-- Task Metadata -->
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Task Information</h3>
                        <dl class="space-y-2">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Current Owner</dt>
                                <dd class="text-sm text-gray-900">
                                    <span class="role-badge">{{task.currentOwner}}</span>
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Git Branch</dt>
                                <dd class="text-sm text-gray-900 font-mono">
                                    {{#if task.gitBranch}}
                                        {{task.gitBranch}}
                                    {{else}}
                                        <span class="text-gray-400">Not assigned</span>
                                    {{/if}}
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Dependencies</dt>
                                <dd class="text-sm text-gray-900">
                                    {{#if task.dependencies.length}}
                                        <div class="space-y-1">
                                            {{#each task.dependencies}}
                                                <div class="text-xs bg-gray-100 px-2 py-1 rounded">{{this}}</div>
                                            {{/each}}
                                        </div>
                                    {{else}}
                                        <span class="text-gray-400">None</span>
                                    {{/if}}
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Last Updated</dt>
                                <dd class="text-sm text-gray-900">{{formatDate task.updatedAt}}</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Acceptance Criteria -->
    {{#if task.description.acceptanceCriteria}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-check-circle text-success-600 mr-2"></i>
                    Acceptance Criteria
                </h3>
                <p class="text-sm text-gray-600 mt-1">Requirements that must be met for task completion</p>
            </div>
            <div class="card-body">
                <div class="space-y-3">
                    {{#each task.description.acceptanceCriteria}}
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 mt-1">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <i class="fas fa-check text-xs text-gray-400"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-gray-700">{{this}}</p>
                            </div>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Implementation Plans -->
    {{#if implementationPlans.length}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-project-diagram text-indigo-600 mr-2"></i>
                    Implementation Plans
                </h3>
                <p class="text-sm text-gray-600 mt-1">Detailed implementation approach and strategy</p>
            </div>
            <div class="card-body">
                {{#each implementationPlans}}
                    <div class="border border-gray-200 rounded-lg p-4 {{#unless @first}}mt-4{{/unless}}">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-md font-medium text-gray-900">Plan #{{add @index 1}}</h4>
                            <span class="text-xs text-gray-500">by {{createdBy}}</span>
                        </div>
                        
                        <div class="space-y-3">
                            {{#if overview}}
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700">Overview</h5>
                                    <p class="text-sm text-gray-600 mt-1">{{overview}}</p>
                                </div>
                            {{/if}}
                            
                            {{#if approach}}
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700">Approach</h5>
                                    <p class="text-sm text-gray-600 mt-1">{{approach}}</p>
                                </div>
                            {{/if}}
                            
                            {{#if filesToModify.length}}
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700">Files to Modify</h5>
                                    <div class="mt-1 flex flex-wrap gap-1">
                                        {{#each filesToModify}}
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono">{{this}}</span>
                                        {{/each}}
                                    </div>
                                </div>
                            {{/if}}
                        </div>
                    </div>
                {{/each}}
            </div>
        </div>
    {{/if}}
    
    <!-- Subtasks by Batch -->
    {{#if subtaskBatches.length}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-layer-group text-orange-600 mr-2"></i>
                    Implementation Batches
                </h3>
                <p class="text-sm text-gray-600 mt-1">Organized subtasks grouped by implementation phase</p>
            </div>
            <div class="card-body">
                <div class="space-y-6">
                    {{#each subtaskBatches}}
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <!-- Batch Header -->
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-md font-medium text-gray-900">{{batchTitle}}</h4>
                                        <p class="text-sm text-gray-600">Batch ID: {{batchId}}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm text-gray-500">{{completedCount}}/{{totalCount}} completed</span>
                                        <div class="w-16 bg-gray-200 rounded-full h-2">
                                            <div 
                                                class="bg-success-600 h-2 rounded-full transition-all duration-1000" 
                                                style="width: {{progressPercentage}}%"
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Subtasks List -->
                            <div class="divide-y divide-gray-200">
                                {{#each subtasks}}
                                    <div class="px-4 py-3 hover:bg-gray-50 transition-colors duration-150">
                                        <div class="flex items-start space-x-3">
                                            <div class="flex-shrink-0 mt-1">
                                                {{#if (eq status 'completed')}}
                                                    <div class="w-5 h-5 rounded-full bg-success-100 flex items-center justify-center">
                                                        <i class="fas fa-check text-success-600 text-xs"></i>
                                                    </div>
                                                {{else if (eq status 'in-progress')}}
                                                    <div class="w-5 h-5 rounded-full bg-primary-100 flex items-center justify-center">
                                                        <i class="fas fa-clock text-primary-600 text-xs"></i>
                                                    </div>
                                                {{else}}
                                                    <div class="w-5 h-5 rounded-full bg-gray-100 flex items-center justify-center">
                                                        <i class="fas fa-circle text-gray-400 text-xs"></i>
                                                    </div>
                                                {{/if}}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <h5 class="text-sm font-medium text-gray-900">{{sequenceNumber}}. {{name}}</h5>
                                                    <span class="status-badge status-{{status}}">{{status}}</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mt-1">{{description}}</p>
                                                {{#if strategicGuidance}}
                                                    <div class="mt-2 text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded">
                                                        <i class="fas fa-lightbulb mr-1"></i>
                                                        Strategic guidance available
                                                    </div>
                                                {{/if}}
                                            </div>
                                        </div>
                                    </div>
                                {{/each}}
                            </div>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Delegation History -->
    {{#if delegationHistory.length}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-exchange-alt text-purple-600 mr-2"></i>
                    Delegation History
                </h3>
                <p class="text-sm text-gray-600 mt-1">Workflow transitions and role handoffs</p>
            </div>
            <div class="card-body">
                <div class="flow-root">
                    <ul class="-mb-8">
                        {{#each delegationHistory}}
                            <li>
                                <div class="relative pb-8 {{#unless @last}}{{else}}pb-0{{/unless}}">
                                    {{#unless @last}}
                                        <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                                    {{/unless}}
                                    <div class="relative flex space-x-3">
                                        <div>
                                            <span class="h-8 w-8 rounded-full bg-primary-500 flex items-center justify-center ring-8 ring-white">
                                                <i class="fas fa-arrow-right text-white text-xs"></i>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                                            <div>
                                                <p class="text-sm text-gray-500">
                                                    Delegated from <span class="role-badge">{{fromRole}}</span> 
                                                    to <span class="role-badge">{{toRole}}</span>
                                                </p>
                                                {{#if message}}
                                                    <p class="text-sm text-gray-700 mt-1">{{message}}</p>
                                                {{/if}}
                                            </div>
                                            <div class="text-right text-sm whitespace-nowrap text-gray-500">
                                                {{formatDate delegatedAt}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        {{/each}}
                    </ul>
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Reports and Reviews -->
    {{#if (or researchReports.length codeReviews.length completionReports.length)}}
        <div class="card animate-on-scroll">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-file-alt text-green-600 mr-2"></i>
                    Reports & Reviews
                </h3>
                <p class="text-sm text-gray-600 mt-1">Research findings, code reviews, and completion reports</p>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Research Reports -->
                    {{#if researchReports.length}}
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-search text-blue-600 mr-2"></i>
                                Research Reports
                            </h4>
                            <div class="space-y-3">
                                {{#each researchReports}}
                                    <div class="border border-gray-200 rounded-lg p-3">
                                        <h5 class="text-sm font-medium text-gray-900">{{title}}</h5>
                                        <p class="text-xs text-gray-600 mt-1">{{summary}}</p>
                                        <div class="mt-2 text-xs text-gray-500">
                                            by {{researchedBy}} • {{formatDate createdAt}}
                                        </div>
                                    </div>
                                {{/each}}
                            </div>
                        </div>
                    {{/if}}
                    
                    <!-- Code Reviews -->
                    {{#if codeReviews.length}}
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-code text-purple-600 mr-2"></i>
                                Code Reviews
                            </h4>
                            <div class="space-y-3">
                                {{#each codeReviews}}
                                    <div class="border border-gray-200 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm font-medium text-gray-900">Review</span>
                                            <span class="status-badge status-{{toLowerCase status}}">{{status}}</span>
                                        </div>
                                        <p class="text-xs text-gray-600">{{summary}}</p>
                                        <div class="mt-2 text-xs text-gray-500">
                                            by {{reviewedBy}} • {{formatDate createdAt}}
                                        </div>
                                    </div>
                                {{/each}}
                            </div>
                        </div>
                    {{/if}}
                    
                    <!-- Completion Reports -->
                    {{#if completionReports.length}}
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-flag-checkered text-success-600 mr-2"></i>
                                Completion Reports
                            </h4>
                            <div class="space-y-3">
                                {{#each completionReports}}
                                    <div class="border border-gray-200 rounded-lg p-3">
                                        <h5 class="text-sm font-medium text-gray-900">Final Report</h5>
                                        <p class="text-xs text-gray-600 mt-1">{{summary}}</p>
                                        <div class="mt-2 text-xs text-gray-500">
                                            {{formatDate createdAt}}
                                        </div>
                                    </div>
                                {{/each}}
                            </div>
                        </div>
                    {{/if}}
                </div>
            </div>
        </div>
    {{/if}}
    
    <!-- Quick Actions -->
    <div class="card animate-on-scroll">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-bolt text-yellow-600 mr-2"></i>
                Quick Actions
            </h3>
            <p class="text-sm text-gray-600 mt-1">MCP commands for this task</p>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button onclick="copyTaskMcpCommand('get-context')" class="btn-secondary text-left p-4 h-auto">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-info-circle text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Get Full Context</div>
                            <div class="text-sm text-gray-500">Retrieve complete task data</div>
                        </div>
                    </div>
                </button>
                
                <button onclick="copyTaskMcpCommand('update-status')" class="btn-secondary text-left p-4 h-auto">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-edit text-green-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Update Status</div>
                            <div class="text-sm text-gray-500">Change task status</div>
                        </div>
                    </div>
                </button>
                
                <button onclick="copyTaskMcpCommand('delegate')" class="btn-secondary text-left p-4 h-auto">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-share text-purple-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Delegate Task</div>
                            <div class="text-sm text-gray-500">Hand off to another role</div>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>
    
</div>

<!-- Task-specific JavaScript -->
<script>
    // Task-specific MCP commands
    const taskMcpCommands = {
        'get-context': `query_task_context({
  taskId: "{{task.taskId}}",
  includeLevel: "comprehensive"
})`,
        'update-status': `task_operations({
  operation: "update",
  taskId: "{{task.taskId}}",
  taskData: {
    status: "completed" // Change as needed
  }
})`,
        'delegate': `workflow_operations({
  operation: "delegate",
  taskId: "{{task.taskId}}",
  fromRole: "{{task.currentOwner}}",
  toRole: "target-role", // Specify target role
  message: "Delegation message"
})`
    };
    
    window.copyTaskMcpCommand = function(commandType) {
        const command = taskMcpCommands[commandType];
        if (command) {
            navigator.clipboard.writeText(command).then(() => {
                showToast(`${commandType.replace('-', ' ')} command copied!`, 'success');
            }).catch(() => {
                showToast('Failed to copy command', 'error');
            });
        }
    };
    
    // Helper for Handlebars
    if (typeof Handlebars !== 'undefined') {
        Handlebars.registerHelper('add', function(a, b) {
            return a + b;
        });
        
        Handlebars.registerHelper('or', function(a, b) {
            return a || b;
        });
    }
</script>

{{/base-layout}} 